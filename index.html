<html>
<head>
<title>Score Maker</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
    function setPreview(data) {
        const preview = document.querySelector('.preview');
        preview.src = "data:image/png;base64," + data;
    }

    function doPreview() {
        const body = document.querySelector('textarea[name="body"]');
        
        fetch('/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                body: body.value,
            }),
        })
        .then(response => response.text())
        .then(data => {
            console.log(data);
            setPreview(data);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const autoUpdate = document.getElementById('auto-update');
        const body = document.querySelector('textarea[name="body"]');
        autoUpdate.addEventListener('change', function() {
            if (autoUpdate.checked) {
                let timeout;
                body.addEventListener('input', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        doPreview();
                    }, 1000);
                });
            } else {
                body.removeEventListener('input', function() {});
            }
        });
    });
</script>
</head>
<body class="p-4">
    <h1 class="text-3xl font-bold">Score Maker</h1>
    <div class="lg:grid grid-cols-2">
        <div class="bg-gray-100 p-4 m-2">
            <form class="">
            <!-- <form method="post" action="/draw" class="bg-gray-100 p-4 m-2"> -->
                <textarea name="body" rows="22"
                class="w-full bg-white text-gray-800 py-1 px-2 border border-gray-400 rounded shadow"
                >BEGIN line
SET duration 2 /* 0 = ronde, 1 = blanche, 2 = noire, etc. */
0 1 2 3 | 4 5 6 7 |</textarea>
                <br/>
                <br/>
                <label class="mr-4"><input type="checkbox" id="auto-update" class="mr-2">Prévisualisation automatique</label>
                <input type="button" onclick="doPreview();" value="Valider" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow">
            </form>
        </div>
        <div class="border p-4 m-2 shadow">
            <img class="preview" src="" alt="" class="max-w-full">
        </div>
    </div>
    <div class="my-2 p-2 bg-red-100 text-red-800">
        <b>Attention</b> : tout n'est pas encore supporté. Une erreur dans le code peut mener à une partition incomplète.
    </div>
    <div>
        <h2 class="mt-4 text-2xl font-bold">Exemple</h2>
        <pre class="bg-gray-100 text-gray-800 p-2 w-fit">/* Ceci est un commentaire */

BEGIN line
SET clef_sharp 1

SET duration 2
0 2 n3 4 | 12. [12 7 10] [6 7] |

BEGIN line

/* On crée un vide qui correspond à la taille du # à la clé de la 1ere ligne */
MOVE 0.33333 forward

SET duration 2
0 2 4 7 | 7 4 2 0 |

SET duration 1
(0 2 4) (4 6 8) |

SET duration 0
(0 2 4 7) |</pre>
        <h2 class="mt-4 text-2xl font-bold">Autre commandes à essayer</h2>
        <ul class="list-disc ml-4">
            <li>SET clef_sharp 3</li>
            <li>SET clef_flat 2</li>
            <li>SET duration 3</li>
            <li>#5 b5 n5</li>
        </ul>
    </div>
</body>
</html>